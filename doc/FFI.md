# Introduction to FFI

这篇文档是有关于FFI机制的一个教学文档，是给不熟悉FFI概念的开发者了解什么是FFI，以及jing项目是如何配合FFI的机制来做封装设计的
读完这篇文档的读者应该对FFI有一个基本的认识，并且知道如何使用jing项目中提供的一些FFI基建去完成自己的功能集

# 基准声明

所有的源码和jep等内容的解读基于当前的LTS版本openjdk25的源码，和所有流行的系统一样，jdk在维持对外接口功能一致的基础上，内部的实现
可能会随着版本进行较大的变化，甚至是完全的重构，因此该文档的内容可能会随着后续jdk版本的变化而产生勘误，读者需要自行进行验证

# Heap vs Non-heap

这个部分讲解jvm中堆内存和堆外内存的一个区别设计

# 标准库的API

讲解bytebuffer的问题

讲解DirectByteBuffer的问题，生命周期的不确定性

讲解netty在这个基础上做了什么改进，设计了ByteBuf来解决一些问题，netty的目前的主线版本是netty4.2.x版本，笔者参考4.2.9版本的源码做解析

# Project Panama带来的模型

讲解project panama里面带来的相关改变，主要是基于jep的内容，做一些额外的提醒和补充

# JNI内部实现用的一些原理

这个地方讲一下jni的模型，包括静态编译和动态加载，如何允许和c层进行交互，函数绑定的机制之类的

# Panama downcall内部实现用的原理
这个可以讲一下libffi的例子，然后就是动态库的原理，dlopen和dlsym之类的，找到具体的函数指针，然后撮合出一个调用

# downcall可以使用到的一些option
讲解downcall里面可以用到的一些option，什么情况下该用这些option，哪些虽然jvm提供了，但是作为开发者不应该在项目中进行使用，会极大的增加维护难度

# Panama upcall的机制
这个地方只是简单的提一下upcall的原理，和c里面的通过函数指针实现回调的机制，upcall会把java函数产生出一个类似c的函数指针，供c进行调用
upcall最大的限制其实是传参问题，因为是从c层面做的传参，参数通常只能是数值类型，导致这个函数很难做一些复杂的逻辑，更多的是用来完成一些通知机制
比如某些C库可能只暴露回调的API设计，此时可以通过upcall，在回调函数中让其给java层的静态容器中，写入一些数据标记，然后java层就能对其进行感知之类的

在jing项目中，没有做upcall的相关设计，因为它会显著的增加复杂度

如果你要开发ffi的动态库（因为宏，内存管理，错误处理，以及兼容性相关的问题，你几乎总是需要自己编写一层c的wrapper），downcall几乎总是你最需要的核心功能
因为你会想要将主要的业务逻辑放在java，少量系统调用或高效算法实现等放在c层面

如果一个项目中同时存在downcall和upcall的使用，很容易会出现套娃的情况，任意一者就已经实现了round trip了，结合使用只会让情况变得无比的复杂
upcall其实是更适合在c层面去实现，这样维护负担会小很多，java已经提供了很好的访问native内存的手段，在c的回调函数中写入内存，再到java层去读取，这个方式会好很多

# arena的实现源码解读，判断是否该在项目中进行使用

这部分的解读是基于jdk25的，后续内部实现可能会发生变化，不保证更新的及时，用户需要自己查看源码进行对照

先是arena.global的实现的讲解，直接就是没有任何的阻碍的一个访问

然后是arena.auto通过gc兜底的一个实现，走的是cleaner的方式

最后是confined，本线程用的一个分配，其实内部封装的就是malloc，通过链表链接

# jing项目的ffm实现

jing项目只使用downcall，不使用upcall，使用任何一者就已经完成了round trip，是完备的，没有必要再引入upcall来增加整体的复杂性
这个地方应该说，downcall，upcall在有自己编写wrapper的情况下，是只需要其一的，如果不编写wrapper，很难做到安全性

ffm的实现走的是定义接口，用注解生成对应的实现类，然后在运行时通过接口拿到实现类的方式，具体的做法可以参考APT部分

然后是option的取舍的部分，只提供了critical和constant两个option，以简化整个模型

# jing项目的内存分配封装

讲一下操作系统内存分配的实际情况，各个内存库都是怎么做的，然后jing项目是如何针对扩容场景，如何用mmap的方式来做优化，
核心是现实世界里面没有最好的统一的内存分配方式，只能说用户越了解自己使用到的相关场景，越能针对自己的情况做出更好的管理方案

